{% extends "base.html" %}
{% load humanize core_extras i18n %}
{% block title %}{% trans "Boshqaruv paneli" %} — {{ APP_NAME }}{% endblock %}
{% block content %}
<h1 class="text-2xl font-semibold text-slate-800 mb-6">{% trans "Boshqaruv paneli" %}</h1>
<p class="text-slate-600 mb-4">{% blocktrans with date=today %}{{ date }} uchun umumiy ko‘rinish{% endblocktrans %}</p>
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
  <div class="bg-white rounded-xl shadow p-5 border border-slate-200 transition-shadow hover:shadow-md">
    <div class="flex items-center gap-2 mb-1">
      <span class="flex-shrink-0 w-10 h-10 rounded-lg bg-emerald-100 flex items-center justify-center">
        <svg class="w-5 h-5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
      </span>
      <p class="text-sm text-slate-500 uppercase tracking-wider">{% trans "Keldi" %}</p>
    </div>
    <p class="text-3xl font-bold text-emerald-600 mt-1">{{ present_count|intcomma }}</p>
  </div>
  <div class="bg-white rounded-xl shadow p-5 border border-slate-200 transition-shadow hover:shadow-md">
    <div class="flex items-center gap-2 mb-1">
      <span class="flex-shrink-0 w-10 h-10 rounded-lg bg-amber-100 flex items-center justify-center">
        <svg class="w-5 h-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
      </span>
      <p class="text-sm text-slate-500 uppercase tracking-wider">{% trans "Kechikkan" %}</p>
    </div>
    <p class="text-3xl font-bold text-amber-600 mt-1">{{ late_count|intcomma }}</p>
  </div>
  <div class="bg-white rounded-xl shadow p-5 border border-slate-200 transition-shadow hover:shadow-md">
    <div class="flex items-center gap-2 mb-1">
      <span class="flex-shrink-0 w-10 h-10 rounded-lg bg-slate-100 flex items-center justify-center">
        <svg class="w-5 h-5 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"/></svg>
      </span>
      <p class="text-sm text-slate-500 uppercase tracking-wider">{% trans "Kelmadi" %}</p>
    </div>
    <p class="text-3xl font-bold text-slate-600 mt-1">{{ absent_count|intcomma }}</p>
  </div>
  <div class="bg-white rounded-xl shadow p-5 border border-slate-200 transition-shadow hover:shadow-md">
    <div class="flex items-center gap-2 mb-1">
      <span class="flex-shrink-0 w-10 h-10 rounded-lg bg-rose-100 flex items-center justify-center">
        <svg class="w-5 h-5 text-rose-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
      </span>
      <p class="text-sm text-slate-500 uppercase tracking-wider">{% trans "Bugungi jarimalar" %}</p>
    </div>
    <p class="text-3xl font-bold text-rose-600 mt-1">{{ total_penalties_today|format_uzs }}</p>
  </div>
</div>
<div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6 items-stretch">
  <div class="bg-white rounded-xl shadow p-4 border border-slate-200 transition-shadow hover:shadow-md flex flex-col min-h-0">
    <h2 class="text-lg font-medium text-slate-800 mb-3">{% trans "Davomat trendi (oxirgi 30 kun)" %}</h2>
    <div class="flex-1 min-h-[200px] lg:min-h-[240px]">
      <canvas id="dashboardChart"></canvas>
    </div>
  </div>
  <div class="grid grid-cols-2 grid-rows-2 gap-4 min-w-0">
    <div class="bg-white rounded-xl shadow p-4 border border-slate-200 flex items-start gap-3">
      <span class="flex-shrink-0 w-9 h-9 rounded-lg bg-emerald-100 flex items-center justify-center"><svg class="w-4 h-4 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg></span>
      <div><p class="text-xs font-medium text-slate-500 uppercase tracking-wider">{% trans "Haftalik (kelganlar)" %}</p><p class="text-2xl font-bold text-slate-800 mt-1">{{ week_came_count|intcomma }}</p><p class="text-xs text-slate-500 mt-1">{% trans "Kechikkan" %}: {{ week_late_count|intcomma }} · {% trans "Jarima" %}: {{ week_penalties_sum|format_uzs }}</p></div>
    </div>
    <div class="bg-white rounded-xl shadow p-4 border border-slate-200 flex items-start gap-3">
      <span class="flex-shrink-0 w-9 h-9 rounded-lg bg-emerald-100 flex items-center justify-center"><svg class="w-4 h-4 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg></span>
      <div><p class="text-xs font-medium text-slate-500 uppercase tracking-wider">{% trans "Oylik (kelganlar)" %}</p><p class="text-2xl font-bold text-slate-800 mt-1">{{ month_came_count|intcomma }}</p><p class="text-xs text-slate-500 mt-1">{% trans "Kechikkan" %}: {{ month_late_count|intcomma }} · {% trans "Jarima" %}: {{ month_penalties_sum|format_uzs }}</p></div>
    </div>
    <div class="bg-white rounded-xl shadow p-4 border border-slate-200 flex items-start gap-3">
      <span class="flex-shrink-0 w-9 h-9 rounded-lg bg-rose-100 flex items-center justify-center"><svg class="w-4 h-4 text-rose-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></span>
      <div><p class="text-xs font-medium text-slate-500 uppercase tracking-wider">{% trans "Jarima statistikasi (oy)" %}</p><p class="text-2xl font-bold text-rose-600 mt-1">{{ month_penalties_sum|format_uzs }}</p><p class="text-xs text-slate-500 mt-1">{% trans "Jami" %} {{ month_penalties_count|intcomma }} {% trans "ta jarima" %}</p></div>
    </div>
    <div class="bg-white rounded-xl shadow p-4 border border-slate-200 flex items-start gap-3">
      <span class="flex-shrink-0 w-9 h-9 rounded-lg bg-slate-100 flex items-center justify-center"><svg class="w-4 h-4 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg></span>
      <div><p class="text-xs font-medium text-slate-500 uppercase tracking-wider">{% trans "Xodimlar" %}</p><p class="text-2xl font-bold text-slate-800 mt-1">{{ employees_active_count|intcomma }} {% trans "faol" %}</p><p class="text-xs text-slate-500 mt-1">{% trans "Jami" %} {{ employees_total_count|intcomma }} {% trans "ta" %}</p></div>
    </div>
  </div>
</div>

{% if late_today %}
<div class="bg-white rounded-xl shadow border border-amber-200 p-4 mb-6">
  <h2 class="text-lg font-medium text-slate-800 mb-3 flex items-center gap-2">
    <svg class="w-5 h-5 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
    {% trans "Kechikkanlar (bugun)" %}
  </h2>
  <ul class="space-y-1.5 text-sm text-slate-700">
    {% for s in late_today %}
    <li><a href="{% url 'employees:detail' s.employee.pk %}" class="link-primary">{{ s.employee.get_full_name }}</a> ({{ s.employee.employee_id }}) — {{ s.minutes_late }} {% trans "daqiqa kechikdi" %}</li>
    {% endfor %}
  </ul>
</div>
{% endif %}

<div class="bg-white rounded-xl shadow border border-slate-200 overflow-hidden">
  <h2 class="text-lg font-medium text-slate-800 p-4 border-b">{% trans "Bugungi xulosa" %}</h2>
  <div class="overflow-x-auto">
    <table class="min-w-full divide-y divide-slate-200">
      <thead class="bg-slate-50">
        <tr>
          <th class="px-4 py-2 text-left text-xs font-medium text-slate-600 uppercase w-12">№</th>
          <th class="px-4 py-2 text-left text-xs font-medium text-slate-600 uppercase"><span class="inline-flex items-center gap-1"><svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>{% trans "Xodim" %}</span></th>
          <th class="px-4 py-2 text-left text-xs font-medium text-slate-600 uppercase"><span class="inline-flex items-center gap-1"><svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>{% trans "Holat" %}</span></th>
          <th class="px-4 py-2 text-left text-xs font-medium text-slate-600 uppercase"><span class="inline-flex items-center gap-1"><svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>{% trans "Kelish" %}</span></th>
          <th class="px-4 py-2 text-left text-xs font-medium text-slate-600 uppercase">{% trans "Ishlash (daq)" %}</th>
          <th class="px-4 py-2 text-left text-xs font-medium text-slate-600 uppercase"><span class="inline-flex items-center gap-1"><svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>{% trans "Kechikish (daq)" %}</span></th>
        </tr>
      </thead>
      <tbody class="divide-y divide-slate-200">
        {% for s in summaries_today %}
        <tr class="hover:bg-slate-50">
          <td class="px-4 py-2 text-slate-500">{{ forloop.counter }}</td>
          <td class="px-4 py-2">
            <span class="inline-flex items-center gap-1.5">
              <svg class="w-4 h-4 text-slate-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
              <a href="{% url 'employees:detail' s.employee.pk %}" class="link-primary">{{ s.employee.employee_id }} — {{ s.employee.get_full_name }}</a>
            </span>
          </td>
          <td class="px-4 py-2">{{ s.get_status_display }}</td>
          <td class="px-4 py-2">{{ s.check_in_time|time:"H:i"|default:"—" }}</td>
          <td class="px-4 py-2">{{ s.working_minutes }}</td>
          <td class="px-4 py-2">{{ s.minutes_late|default:"0" }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="6" class="px-4 py-10 text-center">
          <div class="flex flex-col items-center gap-2 text-slate-500">
            <svg class="w-12 h-12 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
            <span>{% trans "Bugun davomat ma'lumoti yo'q." %}</span>
          </div>
        </td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div class="p-2 border-t"><a href="{% url 'attendance:summary_list' %}?date={{ today|date:'Y-m-d' }}" class="link-primary text-sm inline-flex items-center gap-1">{% trans "To'liq kunlik xulosani ko'rish" %} <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></a></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(function() {
  var canvas = document.getElementById('dashboardChart');
  if (!canvas) return;
  var labels = {{ chart_labels_json|safe }};
  var data = {{ chart_data_json|safe }};
  if (!labels || !data || labels.length === 0) return;
  new Chart(canvas, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{ label: '{{ chart_dataset_label|escapejs }}', data: data, backgroundColor: 'rgba(16, 185, 129, 0.7)', borderColor: 'rgb(5, 150, 105)', borderWidth: 1 }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        y: { beginAtZero: true, ticks: { stepSize: 1 } },
        x: { maxBarThickness: 24 }
      }
    }
  });
})();
</script>
{% endblock %}
